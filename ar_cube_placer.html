<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebXR AR 큐브 배치</title>
    <!-- Tailwind CSS 로드 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter 폰트 설정 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* 캔버스가 화면을 가득 채우도록 설정 */
        body { margin: 0; overflow: hidden; font-family: 'Inter', sans-serif; }
        canvas { display: block; }
        #ar-button {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }
        #message-box {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 20;
        }
        .visible { opacity: 1 !important; }
    </style>
</head>
<body>

    <!-- WebXR 시작 버튼 -->
    <button id="ar-button" class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg transition duration-150 ease-in-out">
        AR 시작
    </button>

    <!-- 메시지 박스 (사용자에게 안내 제공) -->
    <div id="message-box"></div>

    <!-- Three.js 로드 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // 전역 변수 설정
        let camera, scene, renderer;
        let controller;
        let hitTestSource = null;
        let hitTestSourceRequested = false;
        let reticle;
        const placedObjects = [];

        // DOM 요소 가져오기
        const arButton = document.getElementById('ar-button');
        const messageBox = document.getElementById('message-box');

        // 메시지 표시 함수
        function showMessage(text) {
            messageBox.textContent = text;
            messageBox.classList.add('visible');
            clearTimeout(messageBox.timer);
            messageBox.timer = setTimeout(() => {
                messageBox.classList.remove('visible');
            }, 3000);
        }

        // 초기화 함수
        function init() {
            // 1. Scene, Camera, Renderer 설정
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.outputEncoding = THREE.sRGBEncoding;
            renderer.xr.enabled = true; // WebXR 활성화
            document.body.appendChild(renderer.domElement);

            // 2. WebXR 세션 확인 및 버튼 설정
            if (navigator.xr) {
                navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
                    if (supported) {
                        arButton.addEventListener('click', onARButtonClick);
                        arButton.textContent = 'AR 모드 시작';
                        showMessage('WebXR AR 모드를 지원합니다. 버튼을 눌러 시작하세요.');
                    } else {
                        arButton.textContent = 'AR 미지원';
                        arButton.disabled = true;
                        showMessage('이 브라우저는 immersive-ar 세션을 지원하지 않습니다.');
                    }
                }).catch(e => {
                    console.error("WebXR check error:", e);
                    arButton.textContent = 'AR 초기화 실패';
                    arButton.disabled = true;
                });
            } else {
                arButton.textContent = 'WebXR API 없음';
                arButton.disabled = true;
                showMessage('WebXR Device API를 찾을 수 없습니다.');
            }

            // 3. 리사이즈 핸들러
            window.addEventListener('resize', onWindowResize);

            // 4. 리트리클 (배치 위치 표시) 설정
            const geometry = new THREE.RingGeometry(0.05, 0.08, 32).rotateX(-Math.PI / 2);
            const material = new THREE.MeshBasicMaterial({ color: 0xffffff, opacity: 0.8, transparent: true });
            reticle = new THREE.Mesh(geometry, material);
            reticle.matrixAutoUpdate = false; // 수동으로 위치 업데이트
            reticle.visible = false;
            scene.add(reticle);

            // 5. 컨트롤러 설정 (사용자 입력)
            controller = renderer.xr.getController(0);
            controller.addEventListener('select', onSelect);
            scene.add(controller);
        }

        // 윈도우 리사이즈 처리
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // AR 세션 시작 버튼 클릭 핸들러
        function onARButtonClick() {
            // 세션 요청 시 필요한 AR 기능들을 정의
            const sessionInit = {
                requiredFeatures: ['hit-test', 'local'],
                optionalFeatures: ['dom-overlay'], // 선택적으로 DOM 오버레이 사용
            };

            // 세션 요청
            navigator.xr.requestSession('immersive-ar', sessionInit).then(onSessionStarted).catch(error => {
                console.error('AR 세션 요청 실패:', error);
                showMessage(`AR 세션 시작 실패: ${error.message}`);
            });
        }

        // AR 세션 시작 시
        function onSessionStarted(session) {
            session.addEventListener('end', onSessionEnded); // 세션 종료 이벤트 리스너

            renderer.xr.setReferenceSpaceType('local');
            renderer.xr.setSession(session);

            arButton.textContent = 'AR 종료';
            arButton.onclick = () => session.end(); // 버튼 기능 변경

            showMessage('AR 환경이 준비되었습니다. 바닥을 향해 카메라를 움직여 보세요.');

            // 애니메이션 루프 시작
            renderer.setAnimationLoop(render);
        }

        // AR 세션 종료 시
        function onSessionEnded() {
            renderer.setAnimationLoop(null); // 애니메이션 루프 중지
            arButton.textContent = 'AR 모드 시작';
            arButton.onclick = onARButtonClick; // 버튼 기능 복원
            showMessage('AR 세션이 종료되었습니다.');
            
            // 씬 정리 (배치된 객체와 리트리클 제거)
            placedObjects.forEach(obj => scene.remove(obj));
            placedObjects.length = 0;
            reticle.visible = false;
            
            // 히트 테스트 소스 초기화
            hitTestSource = null;
            hitTestSourceRequested = false;
        }

        // 사용자 입력 (터치/클릭) 발생 시
        function onSelect() {
            if (reticle.visible) {
                // 큐브 생성
                const cubeGeometry = new THREE.BoxGeometry(0.2, 0.2, 0.2);
                const cubeMaterial = new THREE.MeshPhongMaterial({ color: 0x6366f1 }); // 인디고 색상
                const cube = new THREE.Mesh(cubeGeometry, cubeMaterial);

                // 리트리클 위치에 큐브 배치
                cube.position.setFromMatrixPosition(reticle.matrix);
                
                // 그림자 및 하이라이트 추가
                cubeMaterial.flatShading = true;
                
                scene.add(cube);
                placedObjects.push(cube);
                showMessage('큐브가 배치되었습니다!');
            } else {
                showMessage('표면을 찾을 수 없습니다. AR 환경을 탐색해 보세요.');
            }
        }

        // 렌더링 루프
        function render(timestamp, frame) {
            if (frame) {
                const referenceSpace = renderer.xr.getReferenceSpace();
                const session = renderer.xr.getSession();

                // 1. 히트 테스트 소스 요청
                if (hitTestSourceRequested === false) {
                    if (session.requestHitTestSource) {
                        session.requestReferenceSpace({ type: 'viewer' }).then((referenceSpace) => {
                            const hitTestRequest = { space: referenceSpace };
                            
                            // 뷰어 공간을 기준으로 화면 중앙에 레이를 생성합니다.
                            session.requestHitTestSource(hitTestRequest).then((source) => {
                                hitTestSource = source;
                            });
                        });
                        session.addEventListener('end', () => hitTestSourceRequested = false);
                        hitTestSourceRequested = true;
                    }
                }

                // 2. 히트 테스트 결과 처리
                if (hitTestSource) {
                    const hitTestResults = frame.getHitTestResults(hitTestSource);

                    if (hitTestResults.length > 0) {
                        const hit = hitTestResults[0];
                        
                        // 히트 위치를 리트리클에 적용
                        const pose = hit.getPose(referenceSpace);
                        reticle.matrix.fromArray(pose.transform.matrix);
                        reticle.visible = true;
                    } else {
                        // 히트 결과가 없으면 리트리클 숨기기
                        reticle.visible = false;
                    }
                }
            }

            // 모든 큐브를 향해 회전하는 광원 (장면이 너무 어두워지지 않게 함)
            const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
            light.position.set(0, 10, 0);
            scene.add(light);
            
            renderer.render(scene, camera);
        }

        init();
    </script>
</body>
</html>